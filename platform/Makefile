.PHONY: help install clean build test lint typecheck dev-web dev-api dev-all docker-up docker-down

# Default target
.DEFAULT_GOAL := help

help: ## Show this help message
	@echo "Appkod Platform - Makefile Commands"
	@echo "===================================="
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

install: ## Install all dependencies (Node + Python)
	@echo "ğŸ“¦ Installing Node dependencies..."
	npm install
	@echo "ğŸ Installing Python dependencies for API..."
	cd packages/api && pip install -e ".[dev]"
	@echo "ğŸ Installing Python dependencies for Runner..."
	cd packages/runner && pip install -e ".[dev]"
	@echo "âœ… All dependencies installed!"

clean: ## Clean all build artifacts and dependencies
	@echo "ğŸ§¹ Cleaning..."
	npm run clean
	find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name '*.pyc' -delete 2>/dev/null || true
	find . -type d -name .pytest_cache -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name .coverage -exec rm -rf {} + 2>/dev/null || true
	@echo "âœ… Clean complete!"

build: ## Build all packages
	@echo "ğŸ”¨ Building all packages..."
	npm run build
	@echo "âœ… Build complete!"

test: ## Run all tests
	@echo "ğŸ§ª Running tests..."
	npm run test
	@echo "âœ… Tests complete!"

lint: ## Lint all code
	@echo "ğŸ” Linting..."
	npm run lint
	cd packages/api && ruff check .
	cd packages/runner && ruff check .
	@echo "âœ… Lint complete!"

typecheck: ## Type check all code
	@echo "ğŸ” Type checking..."
	npm run typecheck
	cd packages/api && mypy .
	cd packages/runner && mypy .
	@echo "âœ… Type check complete!"

validate: ## Run all validation (lint + typecheck + test)
	@echo "âœ… Running full validation pipeline..."
	$(MAKE) lint
	$(MAKE) typecheck
	$(MAKE) test
	@echo "ğŸ‰ All validation passed!"

dev-web: ## Start Next.js web app in dev mode
	@echo "ğŸŒ Starting web app..."
	npm run dev:web

dev-api: ## Start FastAPI backend in dev mode
	@echo "ğŸš€ Starting API..."
	npm run dev:api

dev-all: ## Start all services (requires docker-compose)
	@echo "ğŸš€ Starting all services via docker-compose..."
	docker-compose up

docker-up: ## Start docker-compose services
	@echo "ğŸ³ Starting Docker services..."
	docker-compose up -d
	@echo "âœ… Services started!"
	@echo "ğŸ“Š Web: http://localhost:3000"
	@echo "ğŸ“Š API: http://localhost:8000"
	@echo "ğŸ“Š Runner: http://localhost:8001"

docker-down: ## Stop docker-compose services
	@echo "ğŸ³ Stopping Docker services..."
	docker-compose down
	@echo "âœ… Services stopped!"

docker-logs: ## Tail docker-compose logs
	docker-compose logs -f

docker-rebuild: ## Rebuild and restart docker services
	@echo "ğŸ”¨ Rebuilding Docker images..."
	docker-compose down
	docker-compose build --no-cache
	docker-compose up -d
	@echo "âœ… Rebuild complete!"

format: ## Format all code
	@echo "âœ¨ Formatting code..."
	npm run format --workspaces --if-present
	cd packages/api && ruff format .
	cd packages/runner && ruff format .
	@echo "âœ… Formatting complete!"

contracts-codegen: ## Generate TypeScript types from contracts
	@echo "ğŸ”§ Generating contract types..."
	cd packages/contracts && npm run build
	@echo "âœ… Contract codegen complete!"

security-scan: ## Run security scans (Trivy)
	@echo "ğŸ”’ Running security scans..."
	trivy fs --severity HIGH,CRITICAL .
	@echo "âœ… Security scan complete!"

db-migrate: ## Run database migrations
	@echo "ğŸ“Š Running database migrations..."
	cd packages/api && alembic upgrade head
	@echo "âœ… Migrations complete!"

db-reset: ## Reset database (WARNING: deletes all data)
	@echo "âš ï¸  WARNING: This will delete all database data!"
	@read -p "Are you sure? (y/N): " confirm && [ "$$confirm" = "y" ] || exit 1
	cd packages/api && alembic downgrade base && alembic upgrade head
	@echo "âœ… Database reset complete!"
